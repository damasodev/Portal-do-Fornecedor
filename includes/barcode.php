<?php
if (!isset($_GET['code'])) {
    die("CÃ³digo nÃ£o fornecido.");
}

$code = $_GET['code'];
$width = 400;
$height = 100;
$fontSize = 12;
$print = true;

$im = imagecreate($width, $height);
$white = imagecolorallocate($im, 255, 255, 255);
$black = imagecolorallocate($im, 0, 0, 0);
imagefilledrectangle($im, 0, 0, $width, $height, $white);

$data = code128BarEncode($code);
$x = 10;
$barWidth = 2;

foreach ($data as $bit) {
    $color = ($bit === '1') ? $black : $white;
    imagefilledrectangle($im, $x, 10, $x + $barWidth - 1, $height - 20, $color);
    $x += $barWidth;
}

if ($print) {
    $fontPath = __DIR__ . '/arial.ttf';
    if (file_exists($fontPath)) {
        imagettftext($im, $fontSize, 0, 10, $height - 5, $black, $fontPath, $code);
    } else {
        imagestring($im, 4, 10, $height - 20, $code, $black);
    }
}

header("Content-type: image/png");
imagepng($im);
imagedestroy($im);

function code128BarEncode($code) {
    $codes = [
        ' '=>'11011001100','!'=>'11001101100','"'=>'11001100110','#'=>'10010011000',
        '$'=>'10010001100','%'=>'10001001100','&'=>'10011001000','\''=>'10011000100',
        '('=>'10001100100',')'=>'11001001000','*'=>'11001000100','+'=>'11000100100',
        ','=>'10110011100','-'=>'10011011100','.'=>'10011001110','/'=>'10111001100',
        '0'=>'10011101100','1'=>'10011100110','2'=>'11001110010','3'=>'11001011100',
        '4'=>'11001001110','5'=>'11011100100','6'=>'11001110100','7'=>'11101101110',
        '8'=>'11101001100','9'=>'11100101100','A'=>'11100100110','B'=>'11101100100',
        'C'=>'11100110100','D'=>'11100110010','E'=>'11011011000','F'=>'11011000110',
        'G'=>'11000110110','H'=>'10100011000','I'=>'10001011000','J'=>'10001000110',
        'K'=>'10110001000','L'=>'10001101000','M'=>'10001100010','N'=>'11010001000',
        'O'=>'11000101000','P'=>'11000100010','Q'=>'10110111000','R'=>'10110001110',
        'S'=>'10001101110','T'=>'10111011000','U'=>'10111000110','V'=>'10001110110',
        'W'=>'11101110110','X'=>'11010001110','Y'=>'11000101110','Z'=>'11011101000',
        '['=>'11011100010','\\'=>'11011101110',']'=>'11101011000','^'=>'11101000110',
        '_'=>'11100010110','`'=>'11101101000','a'=>'11101100010','b'=>'11100011010',
        'c'=>'11101111010','d'=>'11001000010','e'=>'11110001010','f'=>'10100110000',
        'g'=>'10100001100','h'=>'10010110000','i'=>'10010000110','j'=>'10000101100',
        'k'=>'10000100110','l'=>'10110010000','m'=>'10110000100','n'=>'10011010000',
        'o'=>'10011000010','p'=>'10000110100','q'=>'10000110010','r'=>'11000010010',
        's'=>'11001010000','t'=>'11110111010','u'=>'11000010100','v'=>'10001111010',
        'w'=>'10100111100','x'=>'10010111100','y'=>'10010011110','z'=>'10111100100',
        '{'=>'10011110100','|'=>'10011110010','}'=>'11110100100','~'=>'11110010100',
        'DEL'=>'11110010010'
    ];

    $bars = '';
    foreach (str_split($code) as $char) {
        $bars .= $codes[$char] ?? '';
    }

    $bars .= '1100011101011'; // STOP code (Code128)
    return str_split($bars);
}
